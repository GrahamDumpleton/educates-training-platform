#!/bin/bash

DOWNLOAD_URL=$1
TARGET_DIR=${2-/home/eduk8s}

if [ "$#" -lt 1 -o -z "$DOWNLOAD_URL" ]; then
  echo "Usage: $0 DOWNLOAD_URL" >&2
  exit 1
fi

GITHUB_RE_1="^github\.com\/([^\/?]+)\/(([^\/?]+)\/?)([^?]+)?(\?(ref=(.*)))?$"

if [[ $DOWNLOAD_URL =~ $GITHUB_RE_1 ]]; then
    ORGANIZATION=${BASH_REMATCH[1]}
    REPOSITORY=${BASH_REMATCH[3]}
    WORKSHOP_PATH=${BASH_REMATCH[4]:-}
    REPOSITORY_REF=${BASH_REMATCH[7]:-master}

    DOWNLOAD_URL="https://github.com/$ORGANIZATION/$REPOSITORY/archive/$REPOSITORY_REF.tar.gz"

    WORKSHOP_PATH=${WORKSHOP_PATH%/}
    STRIP_COMPONENTS=`echo $WORKSHOP_PATH | awk -F'/' '{print NF+1}'`
    TAR_EXTRACT_ARGS="--strip-components $STRIP_COMPONENTS"
fi

curl -sL -o /tmp/download.tar.gz $DOWNLOAD_URL

mkdir -p $TARGET_DIR

tar -C $TARGET_DIR $TAR_EXTRACT_ARGS -xvf /tmp/download.tar.gz --include $REPOSITORY-$REPOSITORY_REF/$WORKSHOP_PATH
