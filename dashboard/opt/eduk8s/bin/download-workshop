#!/bin/bash

set -eo pipefail

FORCE=NO

POSITIONAL=()
while [[ $# -gt 0 ]]
do
key="$1"

case $key in
    --force)
    FORCE=YES
    shift
    ;;
    *)
    POSITIONAL+=("$1")
    shift
    ;;
esac
done
set -- "${POSITIONAL[@]}"

# The target directory is only used for rudimentary testing at present.

DOWNLOAD_URL=$1
TARGET_DIR=$2

if [ "$#" -lt 1 -o -z "$DOWNLOAD_URL" ]; then
  echo "Usage: $0 [--force] DOWNLOAD_URL" >&2
  exit 1
fi

# Don't do download if it has already been run and no --force option.

if [ -f /home/eduk8s/.eduk8s/download-url.txt -a $FORCE != YES ]; then
    echo "Skipping download of $DOWNLOAD_URL"
    exit 0
fi

# Record the location where content was downloaded from so that can
# use the update-workshop script to refresh it. Also used to block use
# of this script again if --force is not used.

if [ -d /home/eduk8s ]; then
    mkdir -p /home/eduk8s/.eduk8s
    echo "$DOWNLOAD_URL" > /home/eduk8s/.eduk8s/download-url.txt
fi

if [ x"$TARGET_DIR" != x"" ]; then
    mkdir -p $TARGET_DIR
fi

# Handle special GitHub repository reference or a HTTP URL to a tarball.

echo "Downloading from $DOWNLOAD_URL"

GITHUB_RE_1="^github\.com\/([^\/?]+)\/(([^\/?]+)\/?)([^?]+)?(\?(ref=(.*)))?$"

if [[ $DOWNLOAD_URL =~ $GITHUB_RE_1 ]]; then
    ORGANIZATION=${BASH_REMATCH[1]}
    REPOSITORY=${BASH_REMATCH[3]}
    WORKSHOP_PATH=${BASH_REMATCH[4]:-}
    REPOSITORY_REF=${BASH_REMATCH[7]:-master}

    DOWNLOAD_URL="https://github.com/$ORGANIZATION/$REPOSITORY/archive/$REPOSITORY_REF.tar.gz"

    WORKSHOP_PATH=${WORKSHOP_PATH%/}

    TARBALL_PATH=$REPOSITORY-$REPOSITORY_REF
    if [ x"$WORKSHOP_PATH" != x"" ]; then
        TARBALL_PATH=$TARBALL_PATH/$WORKSHOP_PATH
    fi

    curl -sL -o /tmp/download.tar.gz $DOWNLOAD_URL

    if [ x"$TARGET_DIR" != x"" ]; then
        tar -C $TARGET_DIR -xvf /tmp/download.tar.gz $TARBALL_PATH

        shopt -s dotglob
        cp -r $TARGET_DIR/$TARBALL_PATH/* $TARGET_DIR
        rm -rf $TARGET_DIR/$REPOSITORY-$REPOSITORY_REF
    else
        tar -C /home/eduk8s -xvf /tmp/download.tar.gz $TARBALL_PATH

        shopt -s dotglob

        cp -r /home/eduk8s/$TARBALL_PATH/* /home/eduk8s
        rm -rf /home/eduk8s/$REPOSITORY-$REPOSITORY_REF

        if [ -d /home/eduk8s/workshop ]; then
            mkdir -p /opt/eduk8s/workshop
            cp -r /home/eduk8s/workshop/* /opt/eduk8s/workshop
            rm -rf /home/eduk8s/workshop
        fi
    fi
else
    curl -sL -o /tmp/download.tar.gz $DOWNLOAD_URL

    if [ x"$TARGET_DIR" != x"" ]; then
        tar -C $TARGET_DIR -xvf /tmp/download.tar.gz
    else
        tar -C /home/eduk8s -xvf /tmp/download.tar.gz

        shopt -s dotglob

        if [ -d /home/eduk8s/workshop ]; then
            mkdir -p /opt/eduk8s/workshop
            cp -r /home/eduk8s/workshop/* /opt/eduk8s/workshop
            rm -rf /home/eduk8s/workshop
        fi
    fi
fi
