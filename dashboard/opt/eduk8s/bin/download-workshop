#!/bin/bash

set -eo pipefail

DOWNLOAD_URL=$1
TARGET_DIR=${2:-/home/eduk8s}

if [ "$#" -lt 1 -o -z "$DOWNLOAD_URL" ]; then
  echo "Usage: $0 DOWNLOAD_URL" >&2
  exit 1
fi

GITHUB_RE_1="^github\.com\/([^\/?]+)\/(([^\/?]+)\/?)([^?]+)?(\?(ref=(.*)))?$"

if [[ $DOWNLOAD_URL =~ $GITHUB_RE_1 ]]; then
    ORGANIZATION=${BASH_REMATCH[1]}
    REPOSITORY=${BASH_REMATCH[3]}
    WORKSHOP_PATH=${BASH_REMATCH[4]:-}
    REPOSITORY_REF=${BASH_REMATCH[7]:-master}

    DOWNLOAD_URL="https://github.com/$ORGANIZATION/$REPOSITORY/archive/$REPOSITORY_REF.tar.gz"

    WORKSHOP_PATH=${WORKSHOP_PATH%/}

    TARBALL_PATH=$REPOSITORY-$REPOSITORY_REF
    if [ x"$WORKSHOP_PATH" != x"" ]; then
        TARBALL_PATH=$TARBALL_PATH/$WORKSHOP_PATH
    fi

    curl -sL -o /tmp/download.tar.gz $DOWNLOAD_URL
    mkdir -p $TARGET_DIR
    tar -C $TARGET_DIR -xvf /tmp/download.tar.gz $TARBALL_PATH

    shopt -s dotglob
    cp -r $TARGET_DIR/$TARBALL_PATH/* $TARGET_DIR
    rm -rf $TARGET_DIR/$REPOSITORY-$REPOSITORY_REF
else
    curl -sL -o /tmp/download.tar.gz $DOWNLOAD_URL
    mkdir -p $TARGET_DIR
    tar -C $TARGET_DIR -xvf /tmp/download.tar.gz
fi
