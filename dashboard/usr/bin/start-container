#!/bin/bash

set -x

set -eo pipefail

# Define what is enabled and disabled.

ENABLE_CONSOLE=${ENABLE_CONSOLE:-false}
ENABLE_DASHBOARD=${ENABLE_DASHBOARD:-true}
ENABLE_EDITOR=${ENABLE_EDITOR:-false}
ENABLE_SLIDES=${ENABLE_SLIDES:-true}
ENABLE_TERMINAL=${ENABLE_TERMINAL:-true}
ENABLE_WEBDAV=${ENABLE_WEBDAV:-false}
ENABLE_WORKSHOP=${ENABLE_WORKSHOP:-true}

if [ x"$WORKSHOP_ONLY" != x"" ]; then
    ENABLE_CONSOLE=false
    ENABLE_DASHBOARD=false
    ENABLE_EDITOR=false
    ENABLE_SLIDES=false
    ENABLE_TERMINAL=false
    ENABLE_WEBDAV=false
    ENABLE_WORKSHOP=true

    DEFAULT_PAGE=workshop
fi

if [ x"$TERMINAL_ONLY" != x"" ]; then
    ENABLE_CONSOLE=false
    ENABLE_DASHBOARD=false
    ENABLE_EDITOR=false
    ENABLE_SLIDES=false
    ENABLE_TERMINAL=true
    ENABLE_WEBDAV=false
    ENABLE_WORKSHOP=false

    DEFAULT_PAGE=terminal
fi

if [ x"$KUBERNETES_SERVICE_HOST" == x"" -o x"$KUBERNETES_SERVICE_PORT" == x"" ]; then
    ENABLE_CONSOLE=false
fi

CONSOLE_VENDOR=${CONSOLE_VENDOR:-kubernetes}

ENABLE_CONSOLE_KUBERNETES=false
ENABLE_CONSOLE_OCTANT=false
ENABLE_CONSOLE_OPENSHIFT=false

if [ x"$ENABLE_CONSOLE" == x"true" ]; then
    case  $CONSOLE_VENDOR  in
        octant) 
            ENABLE_CONSOLE_OCTANT=true
            if [ x"$SESSION_NAMESPACE" != x"" ]; then
                CONSOLE_URL="$INGRESS_PROTOCOL://$SESSION_NAMESPACE-console.$INGRESS_DOMAIN/#/overview/namespace/$SESSION_NAMESPACE"
            else
                CONSOLE_URL="$INGRESS_PROTOCOL://$SESSION_NAMESPACE-console.$INGRESS_DOMAIN/"
            fi
            CONSOLE_PORT=10086
            ;;
        openshift) 
            ENABLE_CONSOLE_OPENSHIFT=true
            if [ x"$SESSION_NAMESPACE" != x"" ]; then
                CONSOLE_URL="$INGRESS_PROTOCOL://$SESSION_NAMESPACE-console.$INGRESS_DOMAIN/k8s/cluster/projects/$SESSION_NAMESPACE/"
            else
                CONSOLE_URL="$INGRESS_PROTOCOL://$SESSION_NAMESPACE-console.$INGRESS_DOMAIN/"
            fi
            CONSOLE_PORT=10087
            ;;
        *) 
            ENABLE_CONSOLE_KUBERNETES=true
            if [ x"$SESSION_NAMESPACE" != x"" ]; then
                CONSOLE_URL="$INGRESS_PROTOCOL://$SESSION_NAMESPACE-console.$INGRESS_DOMAIN/#/overview?namespace=$SESSION_NAMESPACE"
            else
                CONSOLE_URL="$INGRESS_PROTOCOL://$SESSION_NAMESPACE-console.$INGRESS_DOMAIN/"
            fi
            CONSOLE_PORT=10083
            ;;
    esac
fi

if [ x"$ENABLE_EDITOR" == x"true" ]; then
    EDITOR_URL="$INGRESS_PROTOCOL://$SESSION_NAMESPACE-editor.$INGRESS_DOMAIN/"
    EDITOR_PORT=10085
fi

export ENABLE_CONSOLE_KUBERNETES
export ENABLE_CONSOLE_OCTANT
export ENABLE_CONSOLE_OPENSHIFT

export CONSOLE_URL
export EDITOR_URL

export CONSOLE_PORT
export EDITOR_PORT

export ENABLE_CONSOLE
export ENABLE_DASHBOARD
export ENABLE_EDITOR
export ENABLE_SLIDES
export ENABLE_TERMINAL
export ENABLE_WEBDAV
export ENABLE_WORKSHOP

export DEFAULT_PAGE

# Download remote workshop content.

if [ x"$DOWNLOAD_URL" != x"" ]; then
    download-workshop "$DOWNLOAD_URL"
fi

# Work out location of the workshop content.

WORKSHOP_DIR=""

if [ -d /home/eduk8s/workshop ]; then
    WORKSHOP_DIR=/home/eduk8s/workshop
else
    if [ -d /opt/workshop ]; then
        WORKSHOP_DIR=/opt/workshop
    else
        if [ -d /opt/eduk8s/workshop ]; then
            WORKSHOP_DIR=/opt/eduk8s/workshop
        fi
    fi
fi

export WORKSHOP_DIR

# Work out location of slides if provided.

SLIDES_DIR=""

if [ -d /home/eduk8s/workshop/slides ]; then
    SLIDES_DIR=/home/eduk8s/workshop/slides
else
    if [ -d /opt/workshop/slides ]; then
        SLIDES_DIR=/opt/workshop/slides
    else
        if [ -d /opt/eduk8s/workshop/slides ]; then
            SLIDES_DIR=/opt/eduk8s/workshop/slides
        fi
    fi
fi

export SLIDES_DIR

if [ x"$SLIDES_DIR" != x"" ]; then
    SLIDES_URL="$INGRESS_PROTOCOL://$SESSION_NAMESPACE.$INGRESS_DOMAIN/slides/"
fi

export SLIDES_URL

# Setup environment.

. /opt/eduk8s/etc/environment

# Set the working directory for workshop exercises.

EXERCISES_DIR=${EXERCISES_DIR:-exercises}

if [ -d /home/eduk8s/$EXERCISES_DIR ]; then
    TERMINAL_HOME=/home/eduk8s/$EXERCISES_DIR
    export TERMINAL_HOME

    EDITOR_HOME=/home/eduk8s/$EXERCISES_DIR
    export EDITOR_HOME
fi

# Run workshop specific initialisation.

for script in /opt/eduk8s/etc/setup.d/*.sh; do
    if [ -x "$script" ]; then
        $script
    fi
done

for script in /opt/eduk8s/workshop/setup.d/*.sh; do
    if [ -x "$script" ]; then
        $script
    fi
done

for script in /opt/workshop/setup.d/*.sh; do
    if [ -x "$script" ]; then
        $script
    fi
done

for script in /home/eduk8s/workshop/setup.d/*.sh; do
    if [ -x "$script" ]; then
        $script
    fi
done

# Run supervisord.

exec supervisord --nodaemon
