#!/bin/bash

set -x

set -eo pipefail

# Define what is enabled and disabled.

ENABLE_CONSOLE=${ENABLE_CONSOLE:-false}
ENABLE_DASHBOARD=${ENABLE_DASHBOARD:-true}
ENABLE_EDITOR=${ENABLE_EDITOR:-false}
ENABLE_SLIDES=${ENABLE_SLIDES:-true}
ENABLE_TERMINAL=${ENABLE_TERMINAL:-true}
ENABLE_WEBDAV=${ENABLE_WEBDAV:-true}
ENABLE_WORKSHOP=${ENABLE_WORKSHOP:-true}

if [ x"$WORKSHOP_ONLY" != x"" ]; then
    ENABLE_CONSOLE=false
    ENABLE_DASHBOARD=false
    ENABLE_EDITOR=false
    ENABLE_SLIDES=false
    ENABLE_TERMINAL=false
    ENABLE_WEBDAV=false
    ENABLE_WORKSHOP=true

    DEFAULT_PAGE=workshop
fi

if [ x"$TERMINAL_ONLY" != x"" ]; then
    ENABLE_CONSOLE=false
    ENABLE_DASHBOARD=false
    ENABLE_EDITOR=false
    ENABLE_SLIDES=false
    ENABLE_TERMINAL=true
    ENABLE_WEBDAV=false
    ENABLE_WORKSHOP=false

    DEFAULT_PAGE=terminal
fi

if [ x"$KUBERNETES_SERVICE_HOST" == x"" -o x"$KUBERNETES_SERVICE_PORT" == x"" ]; then
    ENABLE_CONSOLE=false
fi

CONSOLE_VENDOR=${CONSOLE_VENDOR:-kubernetes}

ENABLE_CONSOLE_KUBERNETES=false
ENABLE_CONSOLE_OCTANT=false
ENABLE_CONSOLE_OPENSHIFT=false

if [ x"$ENABLE_CONSOLE" == x"true" ]; then
    case  $CONSOLE_VENDOR  in
        octant) 
            ENABLE_CONSOLE_OCTANT=true
            if [ x"$SESSION_NAMESPACE" != x"" ]; then
                CONSOLE_URL="$INGRESS_PROTOCOL://$SESSION_NAMESPACE-console.$INGRESS_DOMAIN/#/overview/namespace/$SESSION_NAMESPACE"
            else
                CONSOLE_URL="$INGRESS_PROTOCOL://$SESSION_NAMESPACE-console.$INGRESS_DOMAIN/"
            fi
            ;;
        openshift) 
            ENABLE_CONSOLE_OPENSHIFT=true
            CONSOLE_URL="$INGRESS_PROTOCOL://$SESSION_NAMESPACE-console.$INGRESS_DOMAIN/"
            ;;
        *) 
            if [ x"$SESSION_NAMESPACE" != x"" ]; then
                CONSOLE_URL="$INGRESS_PROTOCOL://$SESSION_NAMESPACE-console.$INGRESS_DOMAIN/#/overview?namespace=$SESSION_NAMESPACE"
            else
                CONSOLE_URL="$INGRESS_PROTOCOL://$SESSION_NAMESPACE-console.$INGRESS_DOMAIN/"
            fi
            ENABLE_CONSOLE_KUBERNETES=true
            ;;
    esac
fi

export ENABLE_CONSOLE_KUBERNETES
export ENABLE_CONSOLE_OCTANT
export ENABLE_CONSOLE_OPENSHIFT

export CONSOLE_URL

export ENABLE_CONSOLE
export ENABLE_DASHBOARD
export ENABLE_EDITOR
export ENABLE_SLIDES
export ENABLE_TERMINAL
export ENABLE_WEBDAV
export ENABLE_WORKSHOP

export DEFAULT_PAGE

# Download remote workshop content.

if [ x"$DOWNLOAD_URL" != x"" ]; then
    download-workshop "$DOWNLOAD_URL"
fi

# Setup environment.

. /opt/eduk8s/etc/environment

# Run workshop specific initialisation.

for script in /opt/eduk8s/etc/setup.d/*.sh; do
    if [ -x "$script" ]; then
        $script
    fi
done

for script in /home/eduk8s/workshop/setup.d/*.sh; do
    if [ -x "$script" ]; then
        $script
    fi
done

# Run supervisord.

exec supervisord --nodaemon
