#!/bin/bash

set -x

WORKSHOP_ENV=/tmp/workshop-env-$$.sh

SETUP_LOGFILE=$HOME/.local/share/workshop/setup-scripts.log
SETUP_FAILED=$HOME/.local/share/workshop/setup-scripts.failed

cd $HOME

rm -f $SETUP_FAILED
touch $SETUP_LOGFILE

function execute_setup_script() {
    local script=$1
    echo "Executing: $script"
    WORKSHOP_ENV=$WORKSHOP_ENV sh -x $script || touch $SETUP_FAILED || true
    cat $WORKSHOP_ENV
}

for script in /opt/eduk8s/etc/setup.d/*.sh; do
    if [ -x "$script" ]; then
        truncate -s 0 $WORKSHOP_ENV
        execute_setup_script $script 2>&1 | tee -a $SETUP_LOGFILE
        set -a; . $WORKSHOP_ENV; set +a
        rm -f $WORKSHOP_ENV
    fi
done

for script in /opt/eduk8s/etc/profile.d/*.sh /opt/eduk8s/etc/profile.d/sh.local; do
    if [ -r "$script" ]; then
        echo "Source: $script"
        . "$script"
    fi
done

for script in /opt/packages/*/setup.d/*.sh; do
    if [ -x "$script" ]; then
        truncate -s 0 $WORKSHOP_ENV
        execute_setup_script $script 2>&1 | tee -a $SETUP_LOGFILE
        set -a; . $WORKSHOP_ENV; set +a
        rm -f $WORKSHOP_ENV
    fi
done

for script in /opt/packages/*/profile.d/*.sh /opt/packages/*/profile.d/sh.local; do
    if [ -r "$script" ]; then
        echo "Source: $script"
        . "$script"
    fi
done

for script in /opt/workshop/setup.d/*.sh; do
    if [ -x "$script" ]; then
        truncate -s 0 $WORKSHOP_ENV
        execute_setup_script $script 2>&1 | tee -a $SETUP_LOGFILE
        set -a; . $WORKSHOP_ENV; set +a
        rm -f $WORKSHOP_ENV
    fi
done

for script in /opt/workshop/profile.d/*.sh /opt/workshop/profile.d/sh.local; do
    if [ -r "$script" ]; then
        echo "Source: $script"
        . "$script"
    fi
done

for script in $HOME/workshop/setup.d/*.sh; do
    if [ -x "$script" ]; then
        truncate -s 0 $WORKSHOP_ENV
        execute_setup_script $script 2>&1 | tee -a $SETUP_LOGFILE
        set -a; . $WORKSHOP_ENV; set +a
        rm -f $WORKSHOP_ENV
    fi
done

for script in $HOME/workshop/profile.d/*.sh $HOME/workshop/profile.d/sh.local; do
    if [ -r "$script" ]; then
        echo "Source: $script"
        . "$script"
    fi
done
